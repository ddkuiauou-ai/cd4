/*
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆ SECURITIES SECTION - Flexible Grid Interactive Securities Component                             â–ˆâ–ˆ
â–ˆâ–ˆ                                                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ ëª©ì : íšŒì‚¬ì˜ ì¦ê¶Œì„ ìœ ì—°í•œ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜í•˜ê³  ì—°ê²°ë¡œ ì‹œê°í™”                                        â–ˆâ–ˆ
â–ˆâ–ˆ ê¸°ëŠ¥: ì¹´ë“œ ì„ íƒ â†’ ì—°ê²° ì‹œê°í™” â†’ ì˜ì—­ë³„ í•˜ì´ë¼ì´íŠ¸                                                â–ˆâ–ˆ
â–ˆâ–ˆ ìŠ¤íƒ€ì¼: CD3 í‘ë°± ë””ìì¸ ì‹œìŠ¤í…œ (black/white/gray only)                                           â–ˆâ–ˆ
â–ˆâ–ˆ                                                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ Flexible Layout (ìµœëŒ€ 3ì¢…ëª©/ì¤„):                                                                  â–ˆâ–ˆ
â–ˆâ–ˆ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ â”‚   ë³´í†µì£¼  â”‚ ìš°ì„ ì£¼1  â”‚ ìš°ì„ ì£¼2  â”‚  (ì˜ˆì‹œ: ë³´í†µì£¼ + ìš°ì„ ì£¼ ì—¬ëŸ¬ ê°œ)                               â–ˆâ–ˆ
â–ˆâ–ˆ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ â”‚      ì‹œê°€ì´ì•¡ êµ¬ì„± ìš”ì•½       â”‚  (ì „ì²´ í­ ì°¨ì§€)                                                  â–ˆâ–ˆ
â–ˆâ–ˆ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ                                                                                                 â–ˆâ–ˆ
â–ˆâ–ˆ ì—°ê²° ì˜ì—­:                                                                                        â–ˆâ–ˆ
â–ˆâ–ˆ - ê°œë³„ ì¢…ëª© ì„ íƒ: í•´ë‹¹ ì¢…ëª© + ì‹œê°€ì´ì•¡ êµ¬ì„± ì—°ê²°                                                   â–ˆâ–ˆ
â–ˆâ–ˆ - ì‹œê°€ì´ì•¡ êµ¬ì„± ì„ íƒ: ëª¨ë“  ì¢…ëª© + ì‹œê°€ì´ì•¡ êµ¬ì„± ì—°ê²°                                               â–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
*/

"use client";

import { useState, useRef, useEffect } from "react";
import { usePathname, useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import CardMarketcap from "@/components/card-marketcap";
import { MarketcapSummaryExpandable } from "@/components/marketcap-summary-expandable";

type FilterType = "all" | "ë³´í†µì£¼" | "ìš°ì„ ì£¼" | "ì‹œê°€ì´ì•¡ êµ¬ì„±" | string; // ë‹¤ì–‘í•œ ì¦ê¶Œ íƒ€ì… ì§€ì›

interface SecurityData {
    securityId: string;
    type: string;
    ticker: string;
    name: string;
    korName?: string;
    exchange: string;
}

interface InteractiveSecuritiesSectionProps {
    companyMarketcapData: any;
    companySecs: any[];
    currentTicker: string;
    market: string;
    onTickerChange?: (newTicker: string) => void;
    baseUrl?: string; // ê¸°ë³¸ê°’: "company", "security"ë¡œ ë³€ê²½ ê°€ëŠ¥
    currentMetric?: string; // ê¸°ë³¸ê°’: "marketcap", "per" ë“±ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥
    layout?: "main" | "sidebar"; // ë ˆì´ì•„ì›ƒ íƒ€ì…
    maxItems?: number; // ì‚¬ì´ë“œë°”ìš© ì•„ì´í…œ ì œí•œ
    showSummaryCard?: boolean; // ì‹œê°€ì´ì•¡ êµ¬ì„± ì¹´ë“œ í‘œì‹œ ì—¬ë¶€
    compactMode?: boolean; // ê°„ê²°í•œ UI ëª¨ë“œ
    highlightActiveTicker?: boolean; // í™œì„±í™”ëœ ì¢…ëª© ê°•ì¡° ì—¬ë¶€
    defaultFilter?: FilterType; // ì´ˆê¸° ì„ íƒ í•„í„°
}

/**
 * SECURITIES SECTION - Flexible Grid Interactive Component
 *
 * íšŒì‚¬ì˜ ì¦ê¶Œ ëª©ë¡ì„ ìœ ì—°í•œ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜í•˜ê³  ì„ íƒì— ë”°ë¼ ì˜ì—­ì„ ì‹œê°ì ìœ¼ë¡œ ì—°ê²°
 */
export function InteractiveSecuritiesSection({
    companyMarketcapData,
    companySecs,
    currentTicker,
    market,
    onTickerChange,
    baseUrl = "company",
    currentMetric = "marketcap",
    layout = "main",
    maxItems,
    showSummaryCard = true,
    compactMode = false,
    highlightActiveTicker = true,
    defaultFilter = "all"
}: InteractiveSecuritiesSectionProps) {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const [mounted, setMounted] = useState(false);
    const [selectedFilter, setSelectedFilter] = useState<FilterType>(defaultFilter);
    const [isTransitioning, setIsTransitioning] = useState(false);
    const [clickedButton, setClickedButton] = useState<string | null>(null);

    const pathname = usePathname();
    const router = useRouter();
    const containerRef = useRef<HTMLDivElement>(null);

    // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
    const hasValidData = Boolean(
        companyMarketcapData &&
        companySecs &&
        companySecs.length > 0 &&
        currentTicker
    );

    // ìœ íš¨í•œ ì¦ê¶Œ ëª©ë¡ ì¶”ì¶œ ë° ì •ë ¬
    const validSecurities = hasValidData
        ? companyMarketcapData.securities?.filter((sec: any) =>
            sec && sec.type && (sec.type.includes("ë³´í†µì£¼") || sec.type.includes("ìš°ì„ ì£¼"))
        ).sort((a: any, b: any) => {
            // ë³´í†µì£¼ë¥¼ ë¨¼ì €, ê·¸ ë‹¤ìŒ ìš°ì„ ì£¼ë¥¼ ìˆœì„œëŒ€ë¡œ
            if (a.type.includes("ë³´í†µì£¼") && !b.type.includes("ë³´í†µì£¼")) return -1;
            if (!a.type.includes("ë³´í†µì£¼") && b.type.includes("ë³´í†µì£¼")) return 1;
            return a.type.localeCompare(b.type);
        }) || []
        : [];

    // ì¦ê¶Œë³„ ë°ì´í„° ë§¤í•‘
    const securitiesWithData = validSecurities.map((security: any) => {
        const securityData = companySecs.find(
            (companySec: any) => companySec.securityId === security.securityId
        );
        return {
            ...security,
            data: securityData
        };
    }).filter((sec: any) => sec.data); // ë°ì´í„°ê°€ ìˆëŠ” ê²ƒë§Œ

    // ìµœëŒ€ ì•„ì´í…œ ìˆ˜ ì œí•œ (ë ˆì´ì•„ì›ƒì— ë”°ë¼)
    const defaultMaxItems = layout === "sidebar" ? 4 : 3;
    const effectiveMaxItems = maxItems || defaultMaxItems;
    const displaySecurities = securitiesWithData.slice(0, effectiveMaxItems);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ì¹´ë“œ í´ë¦­ í•¸ë“¤ëŸ¬ - ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
    const handleCardClick = (security: any) => {
        console.log('ğŸ”¥ Sidebar Card Click:', {
            securityType: security.type,
            ticker: security.data?.ticker,
            layout: layout,
            currentTicker: currentTicker
        });

        if (!mounted || !hasValidData || isTransitioning || !security.data?.ticker) return;

        // í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
        setClickedButton(security.type);
        setTimeout(() => setClickedButton(null), 200);

        setIsTransitioning(true);
        setSelectedFilter(security.type); console.log('ğŸš€ Card clicked:', security.type, security.data.ticker);

        // URL ë³€ê²½ (ìƒˆë¡œìš´ ì¢…ëª©ìœ¼ë¡œ ì´ë™)
        const secCode = `${security.data.exchange}.${security.data.ticker}`;
        let newUrl = `/${baseUrl}/${secCode}/${currentMetric}`;

        // ë³´í†µì£¼ëŠ” ë©”ì¸/ì‚¬ì´ë“œë°” ê´€ê³„ì—†ì´ focus=stock ì¶”ê°€
        const isCommonStock = security.type?.includes("ë³´í†µì£¼");
        if (isCommonStock) {
            newUrl += "?focus=stock";
        }
        // ë©”ì¸ ì½˜í…ì¸ ì˜ ìš°ì„ ì£¼ë§Œ focus=stock ì¶”ê°€ (ì‚¬ì´ë“œë°” ìš°ì„ ì£¼ëŠ” íŒŒë¼ë¯¸í„° ì—†ìŒ)
        else if (layout !== "sidebar") {
            newUrl += "?focus=stock";
        }

        // Next.js í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì‚¬ìš© (ìŠ¤í¬ë¡¤ ìœ ì§€)
        router.push(newUrl, { scroll: false });

        // ì„ íƒëœ í•„í„° ì—…ë°ì´íŠ¸
        setSelectedFilter(security.type);

        setTimeout(() => setIsTransitioning(false), 300);
    };

    // ìš”ì•½ í´ë¦­ í•¸ë“¤ëŸ¬ - ì‹œê°€ì´ì•¡ êµ¬ì„± (ë³´í†µì£¼ë¡œ ì´ë™, focus ì—†ìŒ)
    const handleSummaryClick = () => {
        if (!mounted || !hasValidData || isTransitioning) return;

        // í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
        setClickedButton("ì‹œê°€ì´ì•¡ êµ¬ì„±");
        setTimeout(() => setClickedButton(null), 200);

        const representativeSecurity = displaySecurities.find((sec: any) =>
            sec.type?.includes("ë³´í†µì£¼")
        ) || displaySecurities[0];

        if (representativeSecurity?.data?.ticker) {
            setIsTransitioning(true);
            setSelectedFilter("ì‹œê°€ì´ì•¡ êµ¬ì„±");

            // ë³´í†µì£¼ URLë¡œ ì´ë™ (focus=stock ì—†ìŒ â†’ ì‹œê°€ì´ì•¡ êµ¬ì„± ì–´ë…¸í…Œì´ì…˜)
            const secCode = `${representativeSecurity.data.exchange}.${representativeSecurity.data.ticker}`;
            const newUrl = `/company/${secCode}/${currentMetric}`;

            // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜
            router.push(newUrl, { scroll: false });

            setTimeout(() => setIsTransitioning(false), 300);
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const getCardStyle = (secType: string) => {
        const isClicked = clickedButton === secType;
        return {
            isClickable: !isTransitioning,
            className: cn(
                "select-none transition-all duration-200",
                !isTransitioning ? "cursor-pointer" : "cursor-default",
                isTransitioning && "pointer-events-none",
                // í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ ì‹œ ë¯¸ë¬˜í•œ ë°°ê²½ ë³€í™” (focus ring ëŒ€ì‹ )
                "focus-visible:bg-muted/60 focus-visible:shadow-md",
                // í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                isClicked && "scale-95 shadow-lg transform-gpu"
            )
        };
    };

    const getSummaryStyle = () => {
        const isClicked = clickedButton === "ì‹œê°€ì´ì•¡ êµ¬ì„±";
        return {
            isClickable: !isTransitioning,
            className: cn(
                "select-none transition-all duration-200",
                !isTransitioning ? "cursor-pointer" : "cursor-default",
                isTransitioning && "pointer-events-none",
                // í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ ì‹œ ë¯¸ë¬˜í•œ ë°°ê²½ ë³€í™” (focus ring ëŒ€ì‹ )
                "focus-visible:bg-muted/60 focus-visible:shadow-md",
                // í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                isClicked && "scale-95 shadow-lg transform-gpu"
            )
        };
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ë§ˆìš´íŠ¸ ì²˜ë¦¬
    useEffect(() => {
        setMounted(true);
    }, []);

    // ì´ˆê¸° í•„í„° ì„¤ì • - URL íŒŒë¼ë¯¸í„° ê³ ë ¤
    useEffect(() => {
        if (!mounted || !hasValidData) {
            setSelectedFilter(defaultFilter);
            return;
        }

        if (!highlightActiveTicker) {
            setSelectedFilter(defaultFilter);
            return;
        }

        const currentSecurity = companySecs.find(sec => sec.ticker === currentTicker);
        if (!currentSecurity) {
            setSelectedFilter(defaultFilter);
            return;
        }

        // URLì—ì„œ focus íŒŒë¼ë¯¸í„° í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const focusStock = urlParams.get('focus') === 'stock';

        // ë³´í†µì£¼ì˜ ê²½ìš°: focus=stock ì—¬ë¶€ë¡œ í•„í„° ê²°ì •
        if (currentSecurity.type?.includes("ë³´í†µì£¼")) {
            setSelectedFilter(focusStock ? "ë³´í†µì£¼" : "ì‹œê°€ì´ì•¡ êµ¬ì„±");
        } else {
            // ìš°ì„ ì£¼ ë“±: ì¢…ëª© íƒ€ì…ìœ¼ë¡œ ì„¤ì •
            setSelectedFilter(currentSecurity.type || defaultFilter);
        }
    }, [mounted, currentTicker, companySecs, hasValidData, highlightActiveTicker, defaultFilter]);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    if (!hasValidData) {
        return (
            <div className="p-6 rounded-xl bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 shadow-sm text-center">
                <div className="space-y-3">
                    <div className="text-gray-700 dark:text-gray-300 font-medium text-base">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤</div>
                    <div className="text-sm text-gray-500 dark:text-gray-400">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
                </div>
            </div>
        );
    }

    if (displaySecurities.length === 0) {
        return (
            <div className="p-6 rounded-xl bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 shadow-sm text-center">
                <div className="space-y-3">
                    <div className="text-gray-700 dark:text-gray-300 font-medium text-base">í‘œì‹œí•  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div className="text-sm text-gray-500 dark:text-gray-400">ì¢…ëª© ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        );
    }

    // ì‚¬ì´ë“œë°” ë ˆì´ì•„ì›ƒ
    if (layout === "sidebar") {
        return (
            <div className="space-y-3">
                {displaySecurities.map((security: any) => {

                    return (
                        <div
                            key={security.securityId}
                            className="relative"
                        >
                            <div
                                className={cn(
                                    getCardStyle(security.type).className,
                                    "group/card relative h-full focus:outline-none focus:ring-0 rounded-lg"
                                )}
                                onClick={getCardStyle(security.type).isClickable ? () => handleCardClick(security) : undefined}
                                onKeyDown={(e) => {
                                    if ((e.key === 'Enter' || e.key === ' ') && getCardStyle(security.type).isClickable) {
                                        e.preventDefault();
                                        handleCardClick(security);
                                    }
                                }}
                                data-card-type={security.type}
                                role={getCardStyle(security.type).isClickable ? "button" : "presentation"}
                                tabIndex={getCardStyle(security.type).isClickable ? 0 : -1}
                                aria-label={`${security.type} - ${security.korName || security.name} ìƒì„¸ë³´ê¸°`}
                            >
                                <CardMarketcap
                                    security={security.data as any}
                                    market={market}
                                    isSelected={highlightActiveTicker && security.data?.ticker === currentTicker}
                                    isCompanyPage={true}
                                    currentMetric={currentMetric}
                                />
                            </div>
                        </div>
                    );
                })}

                {/* ì‹œê°€ì´ì•¡ êµ¬ì„± ì „ì²´ ë³´ê¸° ë²„íŠ¼ (ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì—ì„œë§Œ í‘œì‹œ) */}
                {showSummaryCard && layout !== "sidebar" && (
                    <button
                        onClick={getSummaryStyle().isClickable ? handleSummaryClick : undefined}
                        disabled={!getSummaryStyle().isClickable}
                        className={cn(
                            "block w-full p-3 rounded-lg border transition-all hover:shadow-sm text-left hover:bg-muted/50",
                            !getSummaryStyle().isClickable && "opacity-50 cursor-not-allowed"
                        )}
                    >
                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-foreground">
                                    ì‹œê°€ì´ì•¡ êµ¬ì„±
                                </span>
                            </div>
                            {!compactMode && (
                                <div className="flex justify-between text-xs">
                                    <span className="text-muted-foreground">ì „ì²´ ì¢…ëª©</span>
                                    <span className="font-medium text-foreground">
                                        {companyMarketcapData?.totalMarketcap ?
                                            `${(companyMarketcapData.totalMarketcap / 1e12).toFixed(1)}ì¡°ì›` : "â€”"}
                                    </span>
                                </div>
                            )}
                        </div>
                    </button>
                )}

                {/* ë”ë³´ê¸° ë²„íŠ¼ */}
                {securitiesWithData.length > effectiveMaxItems && (
                    <div className="text-center pt-2">
                        <button className="text-xs text-muted-foreground hover:text-foreground transition-colors">
                            +{securitiesWithData.length - effectiveMaxItems}ê°œ ë”ë³´ê¸°
                        </button>
                    </div>
                )}
            </div>
        );
    }

    // ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ê¸°ì¡´ ë¡œì§)
    return (
        <div ref={containerRef} className={cn(
            "relative w-full",
            "transition-all duration-500 ease-out",
            isTransitioning && "opacity-95"
        )}>

            {/* ìŠ¤í¬ë¦° ë¦¬ë”ìš© ì„¤ëª… */}
            <div className="sr-only">
                ìœ ì—°í•œ ì¢…ëª© í•„í„°ë§ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
                {`í˜„ì¬ ${selectedFilter === "all" ? "ì „ì²´ ë·°" :
                    selectedFilter === "ì‹œê°€ì´ì•¡ êµ¬ì„±" ? "ì‹œê°€ì´ì•¡ êµ¬ì„± ì„ íƒ" : `${selectedFilter} ì„ íƒ`
                    } ìƒíƒœì…ë‹ˆë‹¤.`}
            </div>

            {/* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */}
            <div className="relative">

                {/* ìœ ì—°í•œ ì¦ê¶Œ ê·¸ë¦¬ë“œ */}
                <div className={cn(
                    "grid gap-4 relative z-10 min-h-0 mb-6",
                    displaySecurities.length === 1 ? "grid-cols-1 max-w-sm mx-auto" :
                        displaySecurities.length === 2 ? "grid-cols-1 sm:grid-cols-2 gap-x-6" :
                            "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6"
                )}>

                    {displaySecurities.map((security: any, index: number) => (
                        <div
                            key={security.securityId}
                            className="relative min-h-0"
                        >
                            <div
                                className={cn(
                                    getCardStyle(security.type).className,
                                    "group/card relative h-full focus:outline-none focus:ring-0 rounded-lg"
                                )}
                                onClick={getCardStyle(security.type).isClickable ? () => handleCardClick(security) : undefined}
                                onKeyDown={(e) => {
                                    if ((e.key === 'Enter' || e.key === ' ') && getCardStyle(security.type).isClickable) {
                                        e.preventDefault();
                                        handleCardClick(security);
                                    }
                                }}
                                data-card-type={security.type}
                                role={getCardStyle(security.type).isClickable ? "button" : "presentation"}
                                tabIndex={getCardStyle(security.type).isClickable ? 0 : -1}
                                aria-label={`${security.type} - ${security.korName || security.name} ìƒì„¸ë³´ê¸°`}
                            >
                                <CardMarketcap
                                    security={security.data as any}
                                    market={market}
                                    isSelected={highlightActiveTicker && security.data?.ticker === currentTicker}
                                    isCompanyPage={true}
                                    currentMetric={currentMetric}
                                />
                            </div>
                        </div>
                    ))}

                </div>

                {/* ì‹œê°€ì´ì•¡ êµ¬ì„± ìš”ì•½ */}
                {showSummaryCard && (
                    <div className="relative">
                        <div
                            className={cn(
                                getSummaryStyle().className,
                                "group/summary relative z-10 focus:outline-none focus:ring-0 rounded-lg"
                            )}
                            onClick={getSummaryStyle().isClickable ? handleSummaryClick : undefined}
                            onKeyDown={(e) => {
                                if ((e.key === 'Enter' || e.key === ' ') && getSummaryStyle().isClickable) {
                                    e.preventDefault();
                                    handleSummaryClick();
                                }
                            }}
                            role={getSummaryStyle().isClickable ? "button" : "presentation"}
                            tabIndex={getSummaryStyle().isClickable ? 0 : -1}
                            aria-label="ì‹œê°€ì´ì•¡ êµ¬ì„± ìš”ì•½ - ì „ì²´ ì¢…ëª© êµ¬ì„± í™•ì¸"
                        >
                            <MarketcapSummaryExpandable
                                data={companyMarketcapData}
                                filterType={selectedFilter as any}
                                isSelected={selectedFilter === "ì‹œê°€ì´ì•¡ êµ¬ì„±"}
                            />
                        </div>
                    </div>
                )}

            </div>

        </div>
    );
}

// ê¸°ë³¸ ë‚´ë³´ë‚´ê¸°ë„ ì¶”ê°€
export default InteractiveSecuritiesSection;
