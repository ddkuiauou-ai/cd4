import { notFound } from "next/navigation";
import { ChevronRightIcon } from "@radix-ui/react-icons";
import Link from "next/link";
import { Balancer } from "react-wrap-balancer";
import { Building2, BarChart3, ArrowLeftRight, TrendingUp, FileText, Calculator } from "lucide-react";
import { getSecurityByCode, getCompanySecurities, getSecurityMetricsHistory } from "@/lib/data/security";
import { getCompanyAggregatedMarketcap } from "@/lib/data/company";
import { getPerRank } from "@/lib/data/security";
import { getSecuritySearchNames } from "@/lib/getSearch";
import { getAllSecurityCodes } from "@/lib/select";
import ChartPEREnhanced from "@/components/chart-PER-enhanced";
import ListPEREnhanced from "@/components/list-PER-enhanced";
import { formatNumber, formatDate, formatNumberWithSeparateUnit, formatChangeRate, formatDifference } from "@/lib/utils";
import { CompanyFinancialTabs } from "@/components/company-financial-tabs";
import { InteractiveSecuritiesSection } from "@/components/simple-interactive-securities";
import CompanyLogo from "@/components/CompanyLogo";
import { KeyMetricsSectionPER } from "@/components/key-metrics-section-per";
import { LayoutWrapper } from "@/components/layout-wrapper";

/**
 * Props for Security PER Page
 */
interface SecurityPERPageProps {
  params: Promise<{ secCode: string }>;
}

/**
 * Generate metadata for the security PER page
 */
export async function generateMetadata({ params }: SecurityPERPageProps) {
  const { secCode } = await params;
  const security = await getSecurityByCode(secCode);

  if (!security) {
    return {
      title: "Ï¢ÖÎ™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ - CD3",
      description: "ÏöîÏ≤≠ÌïòÏã† Ï¢ÖÎ™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.",
    };
  }

  return {
    title: `${security.korName || security.name} Ï£ºÍ∞ÄÏàòÏùµÎπÑÏú® PER - CD3`,
    description: `${security.korName || security.name}Ïùò Ïó∞ÎèÑÎ≥Ñ Ï£ºÍ∞ÄÏàòÏùµÎπÑÏú®(PER) Î≥ÄÎèô Ï∞®Ìä∏ÏôÄ ÏÉÅÏÑ∏ Î∂ÑÏÑù Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`,
  };
}

/**
 * Generate static params for all PER pages (SSG)
 */
export async function generateStaticParams() {
  try {
    const securityCodes = await getAllSecurityCodes();

    return securityCodes.map((secCode) => ({
      secCode: secCode,
    }));
  } catch (error) {
    console.error('[GENERATE_STATIC_PARAMS] Error generating PER params:', error);
    return [];
  }
}

/**
 * Security PER Page
 * Displays PER data and charts for a specific security
 */
export default async function SecurityPERPage({ params }: SecurityPERPageProps) {
  const { secCode } = await params;

  const security = await getSecurityByCode(secCode);

  if (!security) {
    notFound();
  }

  const displayName = security.korName || security.name;

  // Extract market from secCode (e.g., "KOSPI.005930" -> "KOSPI")
  const market = secCode.includes('.') ? secCode.split('.')[0] : 'KOSPI';

  // Extract ticker from secCode (e.g., "KOSPI.005930" -> "005930")
  const currentTicker = secCode.includes('.') ? secCode.split('.')[1] : secCode;

  // Get company-related securities if this security has a company
  const companySecs = security.companyId
    ? await getCompanySecurities(security.companyId)
    : [];

  // Ï¢ÖÎ™© ÎπÑÍµêÏö© ÌïÑÌÑ∞ÎßÅ: Î≥¥ÌÜµÏ£ºÏôÄ Ïö∞ÏÑ†Ï£ºÎßå ÌëúÏãú
  const comparableSecurities = companySecs.filter((sec) =>
    sec.type === "Î≥¥ÌÜµÏ£º" || sec.type === "Ïö∞ÏÑ†Ï£º"
  );

  // üî• Ï¢ÖÎ™©Î≥Ñ PER Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä - Ï¢ÖÎ™© ÎπÑÍµêÎ•º ÏúÑÌï¥ ÌòÑÏû¨ PER Í∞íÏùÑ Ìè¨Ìï®
  const comparableSecuritiesWithPER = await Promise.all(
    comparableSecurities.map(async (sec) => {
      try {
        // Í∞Å Ï¢ÖÎ™©Ïùò ÏµúÏã† PER Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const securityWithPER = await getSecurityByCode(`${sec.exchange}.${sec.ticker}`);
        return {
          ...sec,
          per: securityWithPER?.per || null,
          perDate: securityWithPER?.perDate || null,
        };
      } catch (error) {
        console.error(`Failed to get PER data for ${sec.ticker}:`, error);
        return {
          ...sec,
          per: null,
          perDate: null,
        };
      }
    })
  );

  // Get PER data
  const data = await getSecurityMetricsHistory(security.securityId);

  // üî• CD3 Î∞©Ïñ¥Ï†Å ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç: Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ 404 Ï≤òÎ¶¨
  if (!data || data.length === 0) {
    notFound();
  }

  // Get PER rank
  const perRank = await getPerRank(security.securityId);

  // Get company marketcap data for Interactive Securities Section
  let companyMarketcapData = null;
  if (security.companyId) {
    try {
      companyMarketcapData = await getCompanyAggregatedMarketcap(security.companyId);
    } catch (error) {
      // Error is silently handled - fallback to null
    }
  }

  // Transform data to match expected format for PER
  const result = data
    .filter((item) => item.per !== null && item.per !== undefined)
    .map((item) => ({
      date: item.date instanceof Date ? item.date.toISOString().split('T')[0] : String(item.date).split('T')[0],
      value: Number(item.per),
      eps: Number(item.eps || 0),
    }))
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

  // Calculate period analysis for PER
  function calculatePERPeriodAnalysis() {
    if (!result || result.length === 0) return null;

    const latestPER = result.length > 0 ? result[result.length - 1].value : null;

    // Í∏∞Í∞ÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò
    const getDataForPeriod = (months: number) => {
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - months);
      return result.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= cutoffDate;
      });
    };

    // Í∏∞Í∞ÑÎ≥Ñ ÌèâÍ∑† Í≥ÑÏÇ∞
    const periods = [
      { label: 'ÏµúÍ∑º PER', months: 0, desc: 'ÌòÑÏû¨ Í∏∞Ï§Ä' },
      { label: '12Í∞úÏõî ÌèâÍ∑†', months: 12, desc: 'ÏßÅÏ†Ñ 1ÎÖÑ' },
      { label: '3ÎÖÑ ÌèâÍ∑†', months: 36, desc: 'ÏµúÍ∑º 3ÎÖÑ' },
      { label: '5ÎÖÑ ÌèâÍ∑†', months: 60, desc: 'ÏµúÍ∑º 5ÎÖÑ' },
      { label: '10ÎÖÑ ÌèâÍ∑†', months: 120, desc: 'ÏµúÍ∑º 10ÎÖÑ' },
      { label: '20ÎÖÑ ÌèâÍ∑†', months: 240, desc: 'ÏµúÍ∑º 20ÎÖÑ' }
    ];

    const analysis = periods.map(period => {
      if (period.months === 0) {
        return {
          label: period.label,
          value: latestPER || 0,
          desc: period.desc
        };
      }

      const periodData = getDataForPeriod(period.months);
      if (periodData.length === 0) return null;

      const average = periodData.reduce((sum, item) => sum + item.value, 0) / periodData.length;
      return {
        label: period.label,
        value: average,
        desc: period.desc
      };
    }).filter((item): item is NonNullable<typeof item> => item !== null);

    // ÏµúÏ†Ä/ÏµúÍ≥† Í≥ÑÏÇ∞
    const allValues = result.map(item => item.value);
    const minValue = Math.min(...allValues);
    const maxValue = Math.max(...allValues);

    return {
      periods: analysis,
      minMax: { min: minValue, max: maxValue },
      currentSecurity: displayName,
      market,
      latestPER
    };
  }

  const periodAnalysis = calculatePERPeriodAnalysis();

  // Get search data for header
  const searchData = await getSecuritySearchNames();

  // Í≥µÌÜµ NoData Ïª¥Ìè¨ÎÑåÌä∏
  const NoDataDisplay = ({ title, description, iconType = "chart" }: {
    title: string;
    description: string;
    iconType?: "chart" | "table";
  }) => (
    <div className="flex flex-col items-center justify-center p-8 space-y-4 text-center bg-gray-50 dark:bg-gray-900/50 rounded-lg border-2 border-dashed border-gray-200 dark:border-gray-700">
      <div className="w-12 h-12 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center">
        {iconType === "chart" ? (
          <svg className="w-6 h-6 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        ) : (
          <svg className="w-6 h-6 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        )}
      </div>
      <div className="space-y-2">
        <p className="text-sm font-medium text-gray-900 dark:text-gray-100">{title}</p>
        <p className="text-xs text-gray-500 dark:text-gray-400">{description}</p>
      </div>
    </div>
  );

  return (
    <LayoutWrapper searchData={searchData}>
      <main className="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px] space-y-8">
        <div className="mx-auto w-full min-w-0 space-y-12">
          {/* Î∏åÎ†àÎìúÌÅ¨Îüº ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
          <div className="space-y-0">
            <div className="flex items-center space-x-1 text-sm text-muted-foreground">
              <Link href="/" className="hover:text-foreground transition-colors">
                Ìôà
              </Link>
              <ChevronRightIcon className="h-4 w-4" />
              <Link href="/security" className="hover:text-foreground transition-colors">
                Ï¢ÖÎ™©
              </Link>
              <ChevronRightIcon className="h-4 w-4" />
              <Link href={`/security/${secCode}`} className="hover:text-foreground transition-colors">
                {displayName}
              </Link>
              <ChevronRightIcon className="h-4 w-4" />
              <span className="font-medium text-foreground">PER</span>
            </div>
          </div>

          {/* ÌéòÏù¥ÏßÄ Ï†úÎ™© ÏÑπÏÖò */}
          <div className="space-y-6">
            <div className="space-y-2">
              <div className="flex items-center gap-4 mb-4">
                <CompanyLogo
                  companyName={displayName}
                  logoUrl={security.company?.logo}
                  size={64}
                  className="flex-shrink-0"
                />
                <div className="flex-1 min-w-0">
                  <h1 className="font-heading text-3xl md:text-4xl lg:text-5xl font-bold tracking-tight">
                    <Balancer>
                      {displayName} PER
                    </Balancer>
                  </h1>
                </div>
              </div>
              <p className="text-lg md:text-xl text-muted-foreground mt-2">
                {displayName}Ïùò Ï£ºÍ∞ÄÏàòÏùµÎπÑÏú® Price to Earnings Ratio Î∂ÑÏÑù
              </p>
            </div>

            {/* PER ÏÑ§Î™Ö ÏïåÎ¶º */}
            <div data-slot="alert" role="alert" className="relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current bg-card text-card-foreground">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-info h-4 w-4" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
              <div data-slot="alert-description" className="text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed">
                PER(Ï£ºÍ∞ÄÏàòÏùµÎπÑÏú®)ÏùÄ Ï£ºÍ∞ÄÎ•º Ï£ºÎãπÏàúÏù¥Ïùµ(EPS)ÏúºÎ°ú ÎÇòÎàà ÎπÑÏú®ÏûÖÎãàÎã§.
                ÎÇÆÏùÑÏàòÎ°ù Ï£ºÍ∞ÄÍ∞Ä Ï†ÄÌèâÍ∞ÄÎêòÏñ¥ ÏûàÎã§Í≥† Î≥º Ïàò ÏûàÏúºÎ©∞, ÏóÖÏ¢ÖÎ≥Ñ ÎπÑÍµêÍ∞Ä Ï§ëÏöîÌï©ÎãàÎã§.
              </div>
            </div>
          </div>

          <div className="space-y-16">
            {/* Ï¢ÖÎ™© Í∞úÏöî ÏÑπÏÖò */}
            <div id="security-overview" className="relative border-t border-blue-100 dark:border-blue-800/50 pt-8 pb-8 bg-blue-50/30 dark:bg-blue-900/20 rounded-xl -mx-4 px-4">
              <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-800/50">
                  <Building2 className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Ï¢ÖÎ™© Í∞úÏöî</h2>
                  <p className="text-base text-gray-600 dark:text-gray-400 mt-1">PER ÏàúÏúÑÏôÄ Í∏∞Î≥∏ Ï†ïÎ≥¥</p>
                </div>
              </div>

              {/* PER Îû≠ÌÇπ Ïπ¥Îìú */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="flex items-center space-x-3">
                  <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-slate-700 dark:bg-slate-600 text-white">
                    <Calculator className="h-5 w-5" />
                  </div>
                  <div>
                    <p className="text-xl font-bold text-slate-900 dark:text-slate-100">{perRank ? `${perRank}ÏúÑ` : "‚Äî"}</p>
                    <p className="text-sm text-slate-600 dark:text-slate-400">PER Îû≠ÌÇπ</p>
                  </div>
                </div>

                {/* ÏµúÍ∑º PER Ïπ¥Îìú */}
                <div className="flex items-center space-x-3">
                  <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-green-100 dark:bg-green-800/50">
                    <TrendingUp className="h-5 w-5 text-green-600 dark:text-green-400" />
                  </div>
                  <div>
                    <p className="text-xl font-bold text-green-900 dark:text-green-100">
                      {periodAnalysis?.latestPER ? `${periodAnalysis.latestPER.toFixed(2)}Î∞∞` : "‚Äî"}
                    </p>
                    <p className="text-sm text-green-600 dark:text-green-400">ÌòÑÏû¨ PER</p>
                  </div>
                </div>

                {/* ÌòÑÏû¨ Ï£ºÍ∞Ä Ïπ¥Îìú */}
                <div className="flex items-center space-x-3">
                  <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-800/50">
                    <BarChart3 className="h-5 w-5 text-orange-600 dark:text-orange-400" />
                  </div>
                  <div>
                    <p className="text-xl font-bold text-orange-900 dark:text-orange-100">
                      {security.prices?.[0]?.close ? `${security.prices[0].close.toLocaleString()}Ïõê` : "‚Äî"}
                    </p>
                    <p className="text-sm text-orange-600 dark:text-orange-400">ÌòÑÏû¨ Ï£ºÍ∞Ä</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Ï∞®Ìä∏ Î∂ÑÏÑù ÏÑπÏÖò */}
            <div id="chart-analysis" className="space-y-8 relative border-t border-green-100 dark:border-green-800/50 pt-8 pb-8 bg-green-50/20 dark:bg-green-900/20 rounded-xl -mx-4 px-4">
              <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-green-100 dark:bg-green-800/50">
                  <BarChart3 className="h-5 w-5 text-green-600 dark:text-green-400" />
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Ï∞®Ìä∏ Î∂ÑÏÑù</h2>
                  <p className="text-base text-gray-600 dark:text-gray-400 mt-1">PER Ï∂îÏù¥ÏôÄ ÏÉÅÏÑ∏ Î∂ÑÏÑù</p>
                </div>
              </div>

              {/* Ï∞®Ìä∏ Î∂ÑÏÑù - Ï∞®Ìä∏ÏóêÎßå ÏßëÏ§ë */}
              <div className="space-y-4">
                <div className="bg-background rounded-xl border p-2 sm:p-4 shadow-sm">
                  {result && result.length > 0 ? (
                    <ChartPEREnhanced data={result} />
                  ) : (
                    <div className="flex flex-col items-center justify-center p-8 space-y-4 text-center">
                      <div className="w-12 h-12 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center">
                        <svg className="w-6 h-6 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                      </div>
                      <div className="space-y-2">
                        <p className="text-sm font-medium text-gray-900 dark:text-gray-100">PER Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">Ïó∞Í∞Ñ PER Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Ï¢ÖÎ™© ÎπÑÍµê ÏÑπÏÖò */}
            {comparableSecuritiesWithPER && comparableSecuritiesWithPER.length > 1 && (
              <div id="securities-summary" className="space-y-8 relative border-t border-purple-100 dark:border-purple-800/50 pt-8 pb-8 bg-purple-50/20 dark:bg-purple-900/20 rounded-xl -mx-4 px-4">
                <div className="flex items-center gap-3 mb-6">
                  <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-800/50">
                    <ArrowLeftRight className="h-5 w-5 text-purple-600 dark:text-purple-400" />
                  </div>
                  <div>
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Ï¢ÖÎ™© ÎπÑÍµê</h2>
                    <p className="text-base text-gray-600 dark:text-gray-400 mt-1">ÎèôÏùº Í∏∞ÏóÖ ÎÇ¥ Í∞Å Ï¢ÖÎ™© Í∞Ñ PER ÎπÑÍµê</p>
                  </div>
                </div>

                {companyMarketcapData && (
                  <InteractiveSecuritiesSection
                    companyMarketcapData={companyMarketcapData}
                    companySecs={comparableSecuritiesWithPER}
                    market={market}
                    currentTicker={currentTicker}
                    baseUrl="security"
                    currentMetric="per"
                  />
                )}
              </div>
            )}

            <CompanyFinancialTabs secCode={secCode} />

            {/* ÌïµÏã¨ ÏßÄÌëú ÏÑπÏÖò */}
            <div id="indicators" className="border-t border-yellow-100 dark:border-yellow-800/50 pt-8 pb-8 bg-yellow-50/20 dark:bg-yellow-900/20 rounded-xl -mx-4 px-4">
              <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-800/50">
                  <TrendingUp className="h-5 w-5 text-yellow-600 dark:text-yellow-400" />
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">ÌïµÏã¨ ÏßÄÌëú</h2>
                  <p className="text-base text-gray-600 dark:text-gray-400 mt-1">Í∏∞Í∞ÑÎ≥Ñ PER Î∂ÑÏÑù Î∞è ÌÜµÍ≥Ñ</p>
                </div>
              </div>

              {periodAnalysis && (
                <KeyMetricsSectionPER
                  security={security}
                  perRank={perRank}
                  latestPER={periodAnalysis.latestPER}
                  per12Month={periodAnalysis.periods.find(p => p.label === '12Í∞úÏõî ÌèâÍ∑†')?.value || null}
                  per3Year={periodAnalysis.periods.find(p => p.label === '3ÎÖÑ ÌèâÍ∑†')?.value || null}
                  per5Year={periodAnalysis.periods.find(p => p.label === '5ÎÖÑ ÌèâÍ∑†')?.value || null}
                  per10Year={periodAnalysis.periods.find(p => p.label === '10ÎÖÑ ÌèâÍ∑†')?.value || null}
                  per20Year={periodAnalysis.periods.find(p => p.label === '20ÎÖÑ ÌèâÍ∑†')?.value || null}
                  rangeMin={periodAnalysis.minMax.min}
                  rangeMax={periodAnalysis.minMax.max}
                  result={result}
                />
              )}
            </div>

            {/* Ïó∞ÎèÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏÑπÏÖò */}
            <div id="annual-data" className="border-t border-red-100 dark:border-red-800/50 pt-8 pb-8 bg-red-50/20 dark:bg-red-900/20 rounded-xl -mx-4 px-4">
              <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-red-100 dark:bg-red-800/50">
                  <FileText className="h-5 w-5 text-red-600 dark:text-red-400" />
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 tracking-tight">Ïó∞ÎèÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞</h2>
                  <p className="text-base text-gray-600 dark:text-gray-400 mt-1">PER Ï∞®Ìä∏ÏôÄ Ïó∞Îßê Í∏∞Ï§Ä ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞</p>
                </div>
              </div>

              <div className="space-y-8">
                {/* ÏÉÅÏÑ∏ Ï∞®Ìä∏ */}
                <div>
                  <h3 className="text-lg font-semibold mb-4">PER ÏÉÅÏÑ∏ Ï∞®Ìä∏</h3>
                  {result && result.length > 0 ? (
                    <div className="bg-background rounded-xl border p-2 sm:p-4 shadow-sm">
                      <ChartPEREnhanced data={result} />
                    </div>
                  ) : (
                    <NoDataDisplay
                      title="PER Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"
                      description="Ïó∞Í∞Ñ PER Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§"
                      iconType="chart"
                    />
                  )}
                </div>

                {/* Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î */}
                <div className="space-y-6">
                  <h3 className="text-lg font-semibold">Ïó∞ÎèÑÎ≥Ñ PER Îç∞Ïù¥ÌÑ∞</h3>
                  <p className="sr-only">Ïó∞Îßê Í∏∞Ï§Ä PER Ï∂îÏù¥Î•º ÌÜµÌï¥ Î∞∏Î•òÏóêÏù¥ÏÖò Î≥ÄÌôîÎ•º Î∂ÑÏÑùÌï©ÎãàÎã§</p>

                  {result && result.length > 0 ? (
                    <ListPEREnhanced data={result} />
                  ) : (
                    <NoDataDisplay
                      title="Ïó∞ÎèÑÎ≥Ñ PER Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"
                      description="ÏãúÍ≥ÑÏó¥ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§"
                      iconType="table"
                    />
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* ÏÇ¨Ïù¥ÎìúÎ∞î ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò (Îç∞Ïä§ÌÅ¨ÌÜ±) */}
        <div className="hidden xl:block">
          <div className="sticky top-20 space-y-6">
            {/* ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
            <div className="rounded-xl border bg-background p-4">
              <h3 className="text-sm font-semibold mb-3">ÌéòÏù¥ÏßÄ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò</h3>
              <nav className="space-y-2">
                <a
                  href="#security-overview"
                  className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
                >
                  <Building2 className="h-3 w-3" />
                  Ï¢ÖÎ™© Í∞úÏöî
                </a>
                <a
                  href="#chart-analysis"
                  className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
                >
                  <BarChart3 className="h-3 w-3" />
                  Ï∞®Ìä∏ Î∂ÑÏÑù
                </a>
                {comparableSecuritiesWithPER && comparableSecuritiesWithPER.length > 1 && (
                  <a
                    href="#securities-summary"
                    className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
                  >
                    <ArrowLeftRight className="h-3 w-3" />
                    Ï¢ÖÎ™© ÎπÑÍµê
                  </a>
                )}
                <a
                  href="#indicators"
                  className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
                >
                  <TrendingUp className="h-3 w-3" />
                  ÌïµÏã¨ ÏßÄÌëú
                </a>
                <a
                  href="#annual-data"
                  className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors py-1"
                >
                  <FileText className="h-3 w-3" />
                  Ïó∞ÎèÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞
                </a>
              </nav>
            </div>

            {/* Îπ†Î•∏ ÏöîÏïΩ ÏÇ¨Ïù¥ÎìúÎ∞î Ïπ¥Îìú */}
            <div className="rounded-xl border bg-background p-4">
              <h3 className="text-sm font-semibold mb-3">Îπ†Î•∏ ÏöîÏïΩ</h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">ÌòÑÏû¨ PER</span>
                  <span className="font-medium text-foreground">{periodAnalysis?.latestPER ? `${periodAnalysis.latestPER.toFixed(2)}Î∞∞` : "‚Äî"}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">PER Îû≠ÌÇπ</span>
                  <span className="font-medium text-foreground">{perRank ? `${perRank}ÏúÑ` : "‚Äî"}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">ÌòÑÏû¨ Ï£ºÍ∞Ä</span>
                  <span className="font-medium text-foreground">{security.prices?.[0]?.close ? `${security.prices[0].close.toLocaleString()}Ïõê` : "‚Äî"}</span>
                </div>
                <div className="flex justify-between border-t pt-2">
                  <span className="text-muted-foreground">Îç∞Ïù¥ÌÑ∞ Í∏∞Í∞Ñ</span>
                  <span className="font-medium text-foreground">{result.length > 0 ? `${result.length}ÎÖÑ` : "‚Äî"}</span>
                </div>
              </div>
            </div>

            {/* Ï¢ÖÎ™©Î≥Ñ PER ÎπÑÍµê */}
            {comparableSecuritiesWithPER && comparableSecuritiesWithPER.length > 1 && companyMarketcapData && (
              <InteractiveSecuritiesSection
                companyMarketcapData={companyMarketcapData}
                companySecs={comparableSecuritiesWithPER}
                currentTicker={currentTicker}
                market={market}
                layout="sidebar"
                maxItems={4}
                showSummaryCard={true}
                compactMode={false}
                baseUrl="security"
                currentMetric="per"
              />
            )}
          </div>
        </div>
      </main>
    </LayoutWrapper>
  );
}
