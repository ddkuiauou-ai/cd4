# .github/workflows/deploy-netlify.yml

# 워크플로우 이름
name: Build and Deploy to Netlify

# 워크플로우 트리거 조건
on:
  # main 브랜치에 push 될 때 실행되는 부분을 주석 처리하여 비활성화합니다.
  # push:
  #   branches:
  #     - main
  # GitHub Actions 탭에서 수동으로 실행 가능
  workflow_dispatch:

# 동시성 제어: 동일한 브랜치에서 워크플로우가 실행 중일 경우, 진행 중이던 작업을 취소하고 새로운 작업을 시작
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    runs-on: self-hosted
    timeout-minutes: 120
    env:
      NEXT_TELEMETRY_DISABLED: "1"
      # Self-hosted: 10 CPU cores, use more memory and parallel workers
      NODE_OPTIONS: "--max-old-space-size=12288"

    steps:
      # 1. 저장소 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. pnpm 설치 및 설정
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # 3. Node.js 설치 및 pnpm 캐시 설정
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      # 4. 의존성 패키지 설치
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Next.js 프로젝트 빌드 (정적 export)
      - name: Build Next.js
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          NEXT_OUTPUT_MODE: export
        run: pnpm run build

      # 6. 사이트맵 생성 (빌드 성공 시)
      - name: Generate sitemap
        if: success()
        run: pnpm run sitemap

      # 7. Netlify CLI 설치
      - name: Install Netlify CLI
        run: pnpm add -g netlify-cli

      # 8. Netlify에 배포
      - name: Deploy to Netlify
        run: netlify deploy --prod --dir=out
        env:
          # Netlify 인증 토큰 (GitHub Secrets에 저장 필요)
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          # Netlify 사이트 ID (GitHub Secrets에 저장 필요)
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
